# Copyright 2024 Advanced Micro Devices
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

name: E2EAMDSHARK Test Suite unique models
on:
  workflow_dispatch:
  schedule:
   - cron: '30 3 * * 1-6'


jobs:
  e2eamdshark:
    timeout-minutes: 600
    name: "Models :: ${{ matrix.backend }} :: ${{ matrix.test-file }}"
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: mi325_gpu1_test
            runs-on: linux-mi325-1gpu-ossci-nod-ai
            backend: rocm
            device: hip
            target-chip: gfx942
            test-file: nlp-shard1_unique
            cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu2_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: nlp-shard2_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu3_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: nlp-shard3_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu4_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: amdshark-test-suite_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu5_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: vai-hf-cnn-fp32-shard1_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu6_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: vai-hf-cnn-fp32-shard2_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu7_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: vai-hf-cnn-fp32-shard3_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu8_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: vai-int8-p0p1-shard1_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu9_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: vai-int8-p0p1-shard2_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu10_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: vai-int8-p0p1-shard3_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu11_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: vai-vision-int8_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu12_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: migraphx_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu13_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_computer_vision_1_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu14_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_computer_vision_2_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu15_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_computer_vision_3_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu16_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_computer_vision_4_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu17_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_computer_vision_5_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu18_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_gen_ai_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu19_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_graph_ml_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu20_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_nlp_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu21_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_validated_text_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu22_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: onnx_model_zoo_validated_vision_unique
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu23_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_00
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu24_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_01
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu25_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_02
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu26_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_03
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu27_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_04
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu28_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_05
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu29_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_06
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu30_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_07
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu31_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_08
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: mi325_gpu32_test
          ###  runs-on: linux-mi325-1gpu-ossci-nod-ai
          ###  backend: rocm
          ###  device: hip
          ###  target-chip: gfx942
          ###  test-file: hf_onnx_model_zoo_non_legacy_09
          ###  cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          ###- name: cpu_shard1_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: nlp-shard1_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard2_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: nlp-shard2_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard3_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: nlp-shard3_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard4_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: amdshark-test-suite_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard5_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: vai-hf-cnn-fp32-shard1_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard6_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: vai-hf-cnn-fp32-shard2_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard7_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: vai-hf-cnn-fp32-shard3_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard8_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: vai-int8-p0p1-shard1_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard9_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: vai-int8-p0p1-shard2_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard10_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: vai-int8-p0p1-shard3_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard11_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: vai-vision-int8_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard12_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: migraphx_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard13_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_computer_vision_1_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard14_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_computer_vision_2_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard15_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_computer_vision_3_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard16_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_computer_vision_4_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard17_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_computer_vision_5_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard18_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_gen_ai_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard19_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_graph_ml_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard20_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_nlp_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard21_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_validated_text_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard22_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: onnx_model_zoo_validated_vision_unique
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard23_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_00
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard24_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_01
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard25_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_02
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard26_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_03
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard27_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_04
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard28_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_05
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard29_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_06
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard30_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_07
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard31_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_08
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
          ###- name: cpu_shard32_test
          ###  runs-on: nodai-cpu-x86-64
          ###  backend: llvm-cpu
          ###  device: local-task
          ###  target-chip: x86_64-linux-gnu
          ###  test-file: hf_onnx_model_zoo_non_legacy_09
          ###  cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
    defaults:
      run:
        shell: bash
    env:
      E2E_VENV_DIR: ${{ github.workspace }}/test-suite_venv
      #EP_VENV_DIR: ${{ github.workspace }}/ep_venv
      ALT_E2E_VENV_DIR: ${{ github.workspace }}/alt-test-suite_venv
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      AZ_PRIVATE_CONNECTION: ${{ secrets.ONNXPRIVATESTORAGE_AZ_PRIVATE_CONNECTION }}
      CACHE_DIR: ${{ matrix.cache-dir }}
    steps:
      - name: "Setting up Python"
        id: setup_python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"

      - name: Checkout Test Suite
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: nod-ai/AMD-SHARK-TestSuite
          path: test-suite

      - name: "Setup alt e2eamdshark python venv"
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 2
          retry_on: error
          shell: bash
          on_retry_command: echo "::warning::Setup venv failed, retrying..."
          command: |
            cd ./test-suite
            rm -rf ${ALT_E2E_VENV_DIR}
            sudo apt update
            sudo apt install wget
            python -m venv ${ALT_E2E_VENV_DIR}
            source ${ALT_E2E_VENV_DIR}/bin/activate
            pip install --upgrade pip
            pip install -r ./alt_e2eamdshark/base_requirements.txt
            pip install -r ./alt_e2eamdshark/iree_requirements.txt
            pip install --no-deps -r ./alt_e2eamdshark/torch_mlir_requirements.txt
            pip install --pre --upgrade iree-base-compiler iree-base-runtime -f https://iree.dev/pip-release-links.html

      #- name: "Setup IREE EP python venv"
      #  run: |
      #    sudo apt update
      #    sudo apt install wget
      #    python -m venv ${EP_VENV_DIR}
      #    source ${EP_VENV_DIR}/bin/activate
      #    pip install --upgrade pip
      #    pip install -r ./alt_e2eamdshark/base_requirements.txt
      #    pip install -r ./alt_e2eamdshark/iree_requirements.txt
      #    pip install --no-deps -r ./alt_e2eamdshark/torch_mlir_requirements.txt
      #    pip uninstall -y onnxruntime
      #    wget https://amdsharkpublic.blob.core.windows.net/amdsharkpublic/onnxruntime/pip_whl/onnxruntime-1.20.0-cp311-cp311-linux_x86_64.whl
      #    pip install ./onnxruntime-1.20.0-cp311-cp311-linux_x86_64.whl
      #  working-directory: ./test-suite

      - name: Run Onnx Bench Mode
        if: contains(matrix.test-file, 'migraphx')
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 120
          max_attempts: 2
          retry_on: error
          shell: bash
          on_retry_command: echo "::warning::Onnx bench mode failed, retrying..."
          command: |
            cd ./test-suite
            source ${ALT_E2E_VENV_DIR}/bin/activate
            pip freeze
            cd alt_e2eamdshark
            free -mh
            python ./run.py \
              -r ./test-onnx \
              --report \
              --testsfile onnx_tests/models/external_lists/${{ matrix.test-file }}.txt \
              -b ${{ matrix.backend }} \
              -d ${{ matrix.device }} \
              -c ${{ matrix.target-chip }} \
              --report-file reports/${{ matrix.test-file }}.md \
              --mode=cl-onnx-iree \
              --cleanup=3 \
              --benchmark \
              --get-metadata \
              -v
            python utils/find_duplicate_models.py -s -r ./test-onnx -o reports/duplicates.json

      - name: Run Onnx Default Mode
        if: ${{ ! contains(matrix.test-file, 'migraphx') && ! contains(matrix.test-file, 'onnxrt-iree-ep') }}
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 120
          max_attempts: 2
          retry_on: error
          shell: bash
          on_retry_command: echo "::warning::Onnx default mode failed, retrying..."
          command: |
            cd ./test-suite
            source ${ALT_E2E_VENV_DIR}/bin/activate
            pip freeze
            cd alt_e2eamdshark
            free -mh
            python ./run.py \
              -r ./test-onnx \
              --report \
              --testsfile onnx_tests/models/external_lists/${{ matrix.test-file }}.txt \
              -b ${{ matrix.backend }} \
              -d ${{ matrix.device }} \
              -c ${{ matrix.target-chip }} \
              --report-file reports/${{ matrix.test-file }}.md \
              --mode=cl-onnx-iree \
              --cleanup=3 \
              --get-metadata \
              -v
            python utils/find_duplicate_models.py -s -r ./test-onnx -o reports/duplicates.json

      #- name: Run OnnxRT IREE EP
      #  if: contains(matrix.test-file, 'onnxrt-iree-ep')
      #  run: |
      #    source ${EP_VENV_DIR}/bin/activate
      #    export COMPILER_PATH=$(python -c "import iree.compiler as _; print(_.__path__[0])")
      #    export LD_LIBRARY_PATH="$COMPILER_PATH/_mlir_libs/"
      #    echo "COMPILER_PATH=$COMPILER_PATH" >> $GITHUB_ENV
      #    echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH" >> $GITHUB_ENV
      #    pip freeze
      #    cd alt_e2eamdshark
      #    free -mh
      #    python ./run.py -m ort-ep \
      #      -r ./test-onnx \
      #      --report \
      #      --testsfile onnx_tests/models/external_lists/${{ matrix.test-file }}.txt \
      #      -b ${{ matrix.backend }} \
      #      -d ${{ matrix.device }} \
      #      -c ${{ matrix.target-chip }} \
      #      --report-file reports/${{ matrix.test-file }}.md \
      #      --cleanup=3 \
      #      --get-metadata \
      #      -v
      #    python utils/find_duplicate_models.py -s -r ./test-onnx -o reports/duplicates.json
      #  working-directory: ./test-suite

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ci_reports_${{ matrix.backend }}_${{ matrix.test-file }}_onnx_md
          path: ./test-suite/alt_e2eamdshark/reports/${{ matrix.test-file }}.md

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ci_reports_${{ matrix.backend }}_${{ matrix.test-file }}_onnx_json
          path: ./test-suite/alt_e2eamdshark/reports/${{ matrix.test-file }}.json

      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ci_reports_${{ matrix.backend }}_${{ matrix.test-file }}_duplicates_json
          path: ./test-suite/alt_e2eamdshark/duplicates.json

  push_artifacts:
    needs: [e2eamdshark]
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include:
          - name: merge_rocm_reports
            runs-on: linux-mi325-1gpu-ossci-nod-ai
            backend: rocm
            regression-blob: rocm
            device: hip
            target-chip: gfx942
            cache-dir: /home/runner/data/e2eamdshark/amdshark-test-suite-models-cache
          - name: merge_cpu_reports
            runs-on: nodai-cpu-x86-64
            backend: llvm-cpu
            regression-blob: cpu
            device: local-task
            target-chip: x86_64-linux-gnu
            cache-dir: /home/runner/groups/aig_amdsharks/test-suite-ci-cache
    env:
      AZ_PUBLIC_KEY: ${{ secrets.AMD_SHARKPUBLIC_AZ_KEY }}
      CACHE_DIR: ${{ matrix.cache-dir }}
    steps:
      - name: Checkout Test Suite
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: nod-ai/AMD-SHARK-TestSuite
          path: test-suite
      - name: Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: nod-ai/e2eamdshark-reports
          ref: main
          token: ${{ secrets.E2EAMDSHARK_GITHUB_TOKEN }}
          path: e2eamdshark-reports
      - name: "Setting up Python"
        id: setup_python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"
      - name: "Setup alt test suite venv"
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 2
          retry_on: error
          shell: bash
          on_retry_command: echo "::warning::Setup alt test suite venv failed, retrying..."
          command: |
            sudo apt update
            sudo apt install wget
            curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
            python -m venv report_venv_alt
            source report_venv_alt/bin/activate
            pip install --upgrade pip
            pip install -r ./test-suite/alt_e2eamdshark/base_requirements.txt
            pip install -r ./test-suite/alt_e2eamdshark/iree_requirements.txt
            pip install --no-deps -r ./test-suite/alt_e2eamdshark/torch_mlir_requirements.txt
            pip install --pre --upgrade iree-base-compiler iree-base-runtime -f https://iree.dev/pip-release-links.html
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_amdshark-test-suite_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_amdshark-test-suite_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_amdshark-test-suite_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_amdshark-test-suite_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard1_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard1_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard1_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard1_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard2_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard2_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard2_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard2_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard3_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard3_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard3_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-hf-cnn-fp32-shard3_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard1_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard1_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard1_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard1_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard2_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard2_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard2_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard2_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard3_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard3_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard3_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-int8-p0p1-shard3_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-vision-int8_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-vision-int8_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_vai-vision-int8_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_vai-vision-int8_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_migraphx_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_migraphx_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_migraphx_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_migraphx_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_nlp-shard1_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_nlp-shard1_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_nlp-shard1_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_nlp-shard1_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_nlp-shard2_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_nlp-shard2_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_nlp-shard2_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_nlp-shard2_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_nlp-shard3_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_nlp-shard3_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_nlp-shard3_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_nlp-shard3_unique_onnx_json

      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_00_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_00_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_00_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_00_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_01_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_01_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_01_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_01_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_02_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_02_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_02_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_02_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_03_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_03_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_03_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_03_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_04_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_04_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_04_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_04_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_05_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_05_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_05_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_05_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_06_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_06_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_06_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_06_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_07_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_07_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_07_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_07_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_08_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_08_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_08_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_08_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_09_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_09_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_09_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_hf_onnx_model_zoo_non_legacy_09_onnx_json

      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_1_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_1_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_1_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_1_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_2_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_2_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_2_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_2_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_3_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_3_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_3_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_3_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_4_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_4_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_4_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_4_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_5_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_5_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_5_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_computer_vision_5_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_gen_ai_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_gen_ai_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_gen_ai_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_gen_ai_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_graph_ml_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_graph_ml_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_graph_ml_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_graph_ml_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_nlp_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_nlp_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_nlp_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_nlp_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_validated_text_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_validated_text_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_validated_text_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_validated_text_unique_onnx_json
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_validated_vision_unique_onnx_md
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_validated_vision_unique_onnx_md
      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: ci_reports_${{ matrix.backend }}_onnx_model_zoo_validated_vision_unique_onnx_json
          path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnx_model_zoo_validated_vision_unique_onnx_json
      # - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
      #   with:
      #     name: ci_reports_${{ matrix.backend }}_onnxrt-iree-ep_onnx_md
      #     path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnxrt-iree-ep_onnx_md
      # - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
      #   with:
      #     name: ci_reports_${{ matrix.backend }}_onnxrt-iree-ep_onnx_json
      #     path: ./e2eamdshark-reports/ci_reports_${{ matrix.backend }}_onnxrt-iree-ep_onnx_json
      - name: Merge and Push Reports
        run: |
          source report_venv_alt/bin/activate
          ./test-suite/alt_e2eamdshark/scripts/merge_and_push_reports.sh \
            --backend ${{ matrix.backend }} \
            --reports-dir ./e2eamdshark-reports \
            --test-suite-dir ./test-suite \
            --venv-dir ./report_venv_alt

      - name: Regression Reports
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 150
          max_attempts: 2
          retry_on: error
          shell: bash
          on_retry_command: echo "::warning::Regression reports failed, retrying..."
          command: |
            source report_venv_alt/bin/activate
            cd test-suite
            mkdir latest
            mkdir baseline
            wget https://amdsharkpublic.blob.core.windows.net/ciartifacts/latest-test-suite/combined_reports_${{ matrix.backend }}.json -O latest/combined_reports_${{ matrix.backend }}.json
            wget https://amdsharkpublic.blob.core.windows.net/ciartifacts/baseline-test-suite/combined_reports_${{ matrix.regression-blob }}.json -O baseline/combined_reports_${{ matrix.backend }}.json
            cd ..

            python ./test-suite/alt_e2eamdshark/utils/check_regressions.py \
              --new ./e2eamdshark-reports/combined_reports_unique.json \
              --old ./test-suite/latest/combined_reports_${{ matrix.backend }}.json \
              --report-file ./e2eamdshark-reports/yesterday_comparison.md \
              --perf_tol_regression=0.05 \
              --perf_tol_progression=0.05

            cat "e2eamdshark-reports/yesterday_comparison.md" || echo "[WARN] yesterday_comparison.md 1 not found or unreadable"

            # --- Recheck for Regression Models ---

            echo "**************** starting recheck for regression models ****************"
            # generate a json with model name and old status
            MD_FILE="e2eamdshark-reports/yesterday_comparison.md"
            python ./test-suite/alt_e2eamdshark/utils/extract_model_old_new_status_from_md.py "$MD_FILE" || echo "[WARN] Failed to extract model old/new status"
            cat "model_old_new_status.json" || echo "[WARN] model_old_new_status.json not generated"

            JSON_FILE="model_old_new_status.json"
            python ./test-suite/alt_e2eamdshark/utils/extract_regression_model_names.py "$JSON_FILE" || echo "[WARN] Failed to extract regression models from json"
            cat "regression_models.txt" || echo "[WARN] regression_models.txt not generated"

            cd test-suite/alt_e2eamdshark/ || echo "failed to cd into test-suite/alt_e2eamdshark/"
            REGRESSION_MODELS="$PWD/../../regression_models.txt"
            python ./run.py \
               -r ./test-onnx \
               --report \
               --testsfile $REGRESSION_MODELS \
               -b ${{ matrix.backend }} \
               -d ${{ matrix.device }} \
               -c ${{ matrix.target-chip }} \
               --report-file current_result.md \
               --mode=cl-onnx-iree \
               --cleanup=3 \
               --get-metadata \
               -v || echo "[WARN] run.py Regression test execution failed"
            cd ../..

            REGRESSION_MODELS="regression_models.txt"
            BASELINE_JSON="model_old_new_status.json"
            CURRENT_JSON="test-suite/alt_e2eamdshark/current_result.json"
            REPORT_MD="e2eamdshark-reports/yesterday_comparison.md"

            if [[ ! -f "$REGRESSION_MODELS" ]]; then
              echo "[WARN] regression_models.txt missing  skipping per-model updates"
            else
              while IFS= read -r MODEL; do
                # skip empty lines
                [[ -z "$MODEL" ]] && continue

                echo "Processing model: $MODEL"

                python test-suite/alt_e2eamdshark/utils/check_model_status_and_remove.py \
                  "$MODEL" \
                  "$BASELINE_JSON" \
                  "$CURRENT_JSON" \
                  "$REPORT_MD" || echo "[WARN] Failed to process model: $MODEL in check_model_status_and_remove.py"

              done < "$REGRESSION_MODELS"
            fi

            cat "e2eamdshark-reports/yesterday_comparison.md" || echo "[WARN] yesterday_comparison.md 2 not found or unreadable"

            echo "**************** starting recheck for regression models ****************"

            python ./test-suite/alt_e2eamdshark/utils/check_regressions.py \
              --new ./e2eamdshark-reports/combined_reports_unique.json \
              --old ./test-suite/baseline/combined_reports_${{ matrix.backend }}.json \
              --report-file ./e2eamdshark-reports/baseline_comparison.md \
              --perf_tol_regression=0.1 \
              --perf_tol_progression=0.1

            az storage blob upload --account-name amdsharkpublic --container-name ciartifacts \
              --name latest-test-suite/combined_reports_${{ matrix.backend }}.json \
              --file ./e2eamdshark-reports/combined_reports_unique.json \
              --account-key ${AZ_PUBLIC_KEY} --overwrite

      - name: Push regression artifacts
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"
          git pull
          date=$(date '+%Y-%m-%d')
          cp yesterday_comparison.md ${date}/ci_reports_onnx/${{ matrix.backend }}/combined-reports_unique/yesterday_comparison.md
          cp baseline_comparison.md ${date}/ci_reports_onnx/${{ matrix.backend }}/combined-reports_unique/baseline_comparison.md
          git add $date
          git commit -m "add CI regression reports for e2eamdshark for ${{ matrix.backend }}"
          git push origin main
        working-directory: ./e2eamdshark-reports
