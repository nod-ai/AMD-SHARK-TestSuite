# Example workflow demonstrating step-level retry for transient failures
# This simulates the kind of flaky failures that can occur during dependency installation

name: Retry Demo - Simulating Transient Failures

on:
  workflow_dispatch:  # Manual trigger for testing
  pull_request:       # Runs on pull requests
    branches:
      - main
      - 'update_*'
    paths:
      - '.github/workflows/**'
      - '**.md'

jobs:
  demo-without-retry:
    name: "Demo: No Retry (will fail)"
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow workflow to continue even if this job fails
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Flaky step without retry
        run: |
          echo "Simulating a flaky dependency installation..."
          # 50% chance of failure (simulates network issues, package server problems, etc.)
          if [ $((RANDOM % 2)) -eq 0 ]; then
            echo "ERROR: Failed to install dependencies (simulated transient failure)"
            exit 1
          else
            echo "SUCCESS: Dependencies installed"
          fi

  demo-with-retry:
    name: "Demo: With Retry (will succeed)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Flaky step with automatic retry
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 2
          retry_on: error
          shell: bash
          on_retry_command: echo "::warning::First attempt failed, retrying... (This warning shows a retry occurred)"
          command: |
            echo "Simulating a flaky dependency installation..."

            # 50% chance of failure on first try
            if [ ! -f /tmp/retry_marker ]; then
              # First attempt - simulate failure
              echo "First attempt - simulating transient failure"
              echo "ERROR: Connection timeout (simulated)"
              touch /tmp/retry_marker
              exit 1
            else
              # Second attempt - succeed
              echo "Second attempt - SUCCESS!"
              echo "Dependencies installed successfully"
              echo "::notice::This step succeeded on retry - check logs for ::warning:: to see retry occurred"
            fi

  demo-all-retries-fail:
    name: "Demo: All Retries Fail (job will fail)"
    runs-on: ubuntu-latest
    continue-on-error: true  # Allow workflow to continue to show the failure behavior
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Step that fails on all attempts
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 2
          max_attempts: 2
          retry_on: error
          shell: bash
          on_retry_command: echo "::warning::Attempt failed, retrying... (will fail again)"
          command: |
            echo "Simulating a persistent failure (not transient)..."
            echo "This will fail on BOTH attempts"
            echo "ERROR: Permanent failure - database not configured"
            exit 1

  realistic-example:
    name: "Realistic: Python venv setup with retry"
    runs-on: ubuntu-latest
    env:
      VENV_DIR: ${{ github.workspace }}/test_venv
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Python venv with retry (simulates your actual use case)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 2
          retry_on: error
          shell: bash
          on_retry_command: echo "::warning::Python venv setup failed, retrying..."
          command: |
            echo "Setting up Python virtual environment..."
            rm -rf ${VENV_DIR}
            python -m venv ${VENV_DIR}
            source ${VENV_DIR}/bin/activate

            # Simulate occasional pip install failures
            if [ ! -f /tmp/pip_retry_marker ]; then
              echo "Simulating pip install failure (network timeout, package server issue, etc.)"
              touch /tmp/pip_retry_marker
              exit 1
            fi

            pip install --upgrade pip
            echo "Successfully installed dependencies"

      - name: Verify setup succeeded
        run: |
          source ${VENV_DIR}/bin/activate
          python --version
          pip --version
          echo "✓ Virtual environment is ready!"

  comparison-summary:
    name: "Summary: Benefits of Retry"
    runs-on: ubuntu-latest
    if: always()  # Run even if previous jobs failed
    needs: [demo-with-retry, realistic-example]
    steps:
      - name: Display summary
        run: |
          cat << 'EOF'
          ================================================================================
          RETRY MECHANISM SUMMARY
          ================================================================================

          ✓ BENEFITS:
            • Handles transient failures automatically (network issues, server timeouts)
            • Reduces manual re-runs of failed workflows
            • Improves overall CI reliability
            • No code changes needed in your actual tests

          ✓ CONFIGURATION:
            • max_attempts: 2        → Try up to 2 times
            • timeout_minutes: 30    → Each attempt gets 30 minutes
            • retry_on: error        → Retry on any exit code != 0
            • on_retry_command       → Logs ::warning:: when retry occurs

          ✓ FAILURE BEHAVIOR:
            • If ANY attempt succeeds → Job passes ✅
            • If ALL attempts fail → Job fails ❌ (as expected)
            • No silent failures - permanent errors still fail the job
            • Check the "demo-all-retries-fail" job to see this behavior

          ⚠ VISIBILITY NOTE:
            • When a step succeeds after retry, GitHub shows it as passed (✓)
            • The initial failure is hidden in the final status
            • Look for "::warning::" messages in step logs to see if retries happened
            • This is a limitation of the nick-fields/retry action

          ✓ USE CASES:
            • Dependency installation (apt, pip, npm)
            • Network-dependent operations
            • Cloud service API calls
            • Flaky integration tests

          ✓ APPLIED TO YOUR WORKFLOW:
            • "Setup alt e2eamdshark python venv" step
            • "Run HF top-1000 model" step
          ================================================================================
          EOF
